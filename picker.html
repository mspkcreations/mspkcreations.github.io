<!DOCTYPE html>
<html>
<head>
  <title>Drive Picker</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script type="text/javascript">
    // CONFIGURATION
    var DEVELOPER_KEY = 'AIzaSyBSFcGPGdzTofNd915wCXn_lZfv87UKc3I';
    var APP_ID = '230626304410'; 

    var pickerApiLoaded = false;

    function onApiLoad() {
      gapi.load('picker', { 
        'callback': onPickerApiLoad,
        'onerror': function() { alert('gapi.load failed. Check network/blockers.'); }
      });
    }

    function onPickerApiLoad() {
      pickerApiLoaded = true;
      createPicker();
    }

    function createPicker() {
      var hashParams = new URLSearchParams(window.location.hash.substring(1));
      var oauthToken = hashParams.get('token');

      if (pickerApiLoaded && oauthToken) {
        var view = new google.picker.DocsView(google.picker.ViewId.DOCS)
            .setIncludeFolders(true) 
            .setSelectFolderEnabled(true)
            .setMimeTypes('application/vnd.google-apps.folder');

        var origin = window.location.protocol + '//' + window.location.host;

        var picker = new google.picker.PickerBuilder()
            .addView(view)
            .setOAuthToken(oauthToken)
            .setDeveloperKey(DEVELOPER_KEY)
            .setAppId(APP_ID)
            .setCallback(pickerCallback)
            .setOrigin(origin) // <--- CRITICAL FIX: REQUIRED FOR SECURITY
            .build();
        picker.setVisible(true);
      } else {
         // Helpful debugging if it fails again
         if (!oauthToken) alert("Error: Missing 'token' in URL hash");
      }
    }

    function pickerCallback(data) {
      if (data[google.picker.Response.ACTION] == google.picker.Action.PICKED) {
        var doc = data[google.picker.Response.DOCUMENTS][0];
        var fileId = doc[google.picker.Document.ID];
        window.location.href = "medicineapp://picker_result?fileId=" + fileId;
      } else if (data[google.picker.Response.ACTION] == google.picker.Action.ERROR) {
        console.error("Picker Error: ", data);
        alert("Google Error: " + JSON.stringify(data));
      }
    }
  </script>
</head>
<body>
    <script type="text/javascript" src="https://apis.google.com/js/api.js?onload=onApiLoad"></script>
    <p style="text-align:center; margin-top:50px; font-family:sans-serif;">Opening Google Drive...</p>
</body>
</html>
